package com.bcvgh.controller;

import com.bcvgh.core.exp.ExpUsageImp;
import com.bcvgh.utils.PocUtil;
import javafx.application.Platform;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.scene.control.*;
import javafx.scene.layout.AnchorPane;
import javafx.scene.text.Text;

import java.util.HashMap;

public class VulExploitController {

    @FXML
    private MenuBar VulName;

    @FXML
    private Menu VulChoice;

    @FXML
    private TextArea VulOut;

    @FXML
    private AnchorPane Pane;

    @FXML
    private Button VulExploit;

    private HashMap<String, String> Extra = new HashMap<>();

    private HashMap<String, Control> ExtraControls = new HashMap<>();

    public void  initialize() {
        this.VulOut.setWrapText(true);
        this.VulOut.setEditable(false);
        this.VulChoice.setText(PocUtil.name);
        switch (PocUtil.type){
            case "sql":
                break;
            case "upload":
                Text context = new Text("webshell");
                TextArea uploadContext = new TextArea();
                uploadContext.setPrefSize(200,200);
                Pane.getChildren().add(context);
                Pane.getChildren().add(uploadContext);
                this.ExtraControls.put("webshell",uploadContext);
                break;
            case "exec":
                Text cmd = new Text("Command");
                TextField Command = new TextField();
                Pane.getChildren().add(cmd);
                Pane.getChildren().add(Command);
                this.ExtraControls.put("command",Command);
                break;
            case "deserialize":
                break;
        }


    }

    @FXML
    void Exploit(ActionEvent event) {
        this.VulOut.setText("");
        for (String ExtraControl : this.ExtraControls.keySet()){
            Control control = this.ExtraControls.get(ExtraControl);
            if (control instanceof TextArea){
                this.Extra.put(ExtraControl,((TextArea) control).getText());
            }
            else if (control instanceof  TextField){
                this.Extra.put(ExtraControl,((TextField) control).getText());
            }
        }
        ExpUsageImp expUsage = new ExpUsageImp(PocUtil.url, PocUtil.tag, PocUtil.name, this.Extra);
        HashMap<String, String> result = expUsage.result;
//        ArrayList<String> result = expUsage.Result
        try {
            for (String i : result.keySet()){
                if (i.equals("prompt")){
                    Platform.runLater(() -> this.VulOut.appendText(result.get(i)));
                }
                if (i.equals("result")){
                    Platform.runLater(() -> this.VulOut.appendText(result.get(i)));
                }

            }
        }
        catch (Exception e){

        }
    }

}
